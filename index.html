<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<title>稳定图床 - Image Upload - ONSTUDY.CC</title>

<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

<link rel="stylesheet" href="static/css/bootstrap.min.css">

<link rel="stylesheet" href="static/css/font-awesome.css">
<link href="static/css/all.min.css" media="all" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="static/css/ionicons.min.css">
<link rel="stylesheet" href="static/css/notifyme.css">
<link rel="stylesheet" href="static/css/indexstyle.css">

<link rel="stylesheet" href="static/css/fonts.css" media="none" onload="if(media!='all')media='all'">
<script src="static/js/jquery.min.js"></script>


<!--[if lt IE 9]>
    <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<link rel="shortcut icon" href="favicon.ico">
<link rel="bookmark" href="favicon.ico">
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
<div class="container">
<a class="navbar-brand" href="">ONSTUDY.CC</a>
<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarCollapse">
<ul class="navbar-nav mr-auto">
<li class="nav-item active">
<a class="nav-link" href="">Home</a>
</li>
<li class="nav-item">
<a class="nav-link" href="about.html">About</a>
</li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
<a class="nav-link" href="changelog.html">Change Log</a>
</li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" id="drop_api" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">API <span class="caret"></span></a>
<div class="dropdown-menu" aria-labelledby="drop_api">
<a class="dropdown-item" href="#">v1</a>
</div>
</li>
</ul>
</div>
</div>
</nav>

<div class="container kv-main">
<div class="page-header">
<h1>Image Upload</h1> 5 MB max per file. 100 files max per request.
</div>
<form enctype="multipart/form-data">
<div class="form-group" style="max-height: 2000px;">
<input id="file" type="file" multiple="" class="file" data-overwrite-initial="false" data-min-file-count="1" name="file" accept="image/*">
</div>
</form>
<form id="upload_option" enctype="multipart/form-data">
</form>
<div id="showurl" style="display: none;">
<ul id="navTab" class="nav nav-tabs" role="tablist">
<li class="nav-item"><a class="nav-link active" id="imagedetail-tab" href="#imagedetail" data-toggle="tab">Preview</a></li>
<li class="nav-item"><a class="nav-link" id="bbcodePanel-tab" href="#bbcodePanel" data-toggle="tab">BBCode</a></li>
<li class="nav-item"><a class="nav-link" id="htmlcodePanel-tab" href="#htmlcodePanel" data-toggle="tab">HTML</a></li>
<li class="nav-item"><a class="nav-link" id="urlcodePanel-tab" href="#urlcodePanel" data-toggle="tab">Image URL</a></li>
<li class="nav-item"><a class="nav-link" id="markdownPanel-tab" href="#markdownPanel" data-toggle="tab">Markdown</a></li>
<li class="nav-item"><a class="nav-link" id="removePanel-tab" href="#removePanel" data-toggle="tab">Remove Link</a></li>
</ul>
<div id="navTabContent" class="tab-content" style="border:none;">
<div class="tab-pane fade show active" id="imagedetail" role="tabpanel" aria-labelledby="imagedetail-tab"></div>
<div class="tab-pane fade" id="bbcodePanel" role="tabpanel" aria-labelledby="bbcodePanel-tab">
<pre onclick="clip(this);" style="margin-top: 5px;"><code id="bbcode"></code></pre>
</div>
<div class="tab-pane fade" id="htmlcodePanel" role="tabpanel" aria-labelledby="htmlcodePanel-tab">
<pre onclick="clip(this);" style="margin-top: 5px;"><code id="htmlcode"></code></pre>
</div>
<div class="tab-pane fade" id="urlcodePanel" role="tabpanel" aria-labelledby="urlcodePanel-tab">
<pre onclick="clip(this);" style="margin-top: 5px;"><code id="urlcode"></code></pre>
</div>
<div class="tab-pane fade" id="markdownPanel" role="tabpanel" aria-labelledby="markdownPanel-tab">
<pre onclick="clip(this);" style="margin-top: 5px;"><code id="markdown"></code></pre>
</div>
<div class="tab-pane fade" id="removePanel" role="tabpanel" aria-labelledby="removePanel-tab">
<pre onclick="clip(this);" style="margin-top: 5px;"><code id="removelink"></code></pre>
</div>
</div>
</div>
<div class="page-footer">
</div>

</div>

<footer class="footer">
<div class="container">
<div class="row">
<div class="col-lg-6">
<p class="text-muted">请不要上传你觉得可能带来麻烦的图片，谢谢合作。</p>
</div>
</div>
</div>
</footer>

<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/layer.js"></script>
<script src="static/js/sweetalert.min.js"></script>
<link href="static/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css">
<link href="static/css/all.min.css" media="all" rel="stylesheet" type="text/css">

<script src="static/js/jquery.dataTables.min.js"></script>
<script src="static/js/bootstrap.min.js"></script>

<script src="static/js/layer.js"></script>

<script src="static/js/jquery.lazyload.min.js" type="text/javascript"></script>

<script src="static/js/bootstrap.min.js" type="text/javascript"></script>
<script src="static/js/sortable.min.js" type="text/javascript"></script>
<script src="static/js/purify.min.js" type="text/javascript"></script>
<script src="static/js/fileinput_new.js" type="text/javascript"></script>
<script src="static/js/theme.min.js"></script>
<script src="static/js/zh.js" type="text/javascript"></script>
<script src="static/js/purify.min1.js" type="text/javascript"></script>
<script src="static/js/handlebars.min.js" type="text/javascript"></script>
<script id="image-template" type="text/x-handlebars-template">
        <fieldset style="margin-top: 10px;">
            <legend><img src="https://p.sda1.dev/assets/images/icons/photo.png" alt="" style="vertical-align:middle; line-height:16px; height:16px; padding-right:5px;">{{filename}}</legend>
            <table style="width:100%;">
                <tbody><tr>
                    <td style="width:260px; text-align: center;">
                        <img class="lazy" onload="DrawImage(this, 260, 260)" width="{{width}}" height="{{height}}" src="{{url}}" style="max-width: 300px;max-height: 300px;">
                    </td>
                    <td class="padding10" style="text-align:left;">
                      <div class="dlinput_header">URL</div>
                      <div class="dlinput_container">
                          <div class="row">
                              <div class="col-md-8">
                                  <input class="form-control" type="text" onclick="this.select();" value="{{url}}">
                              </div>
                          </div>
                      </div>
                        <div class="dlinput_header">HTML</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="<img src=&quot;{{url}}&quot; >">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">BBCode</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="[img]{{url}}[/img]">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">Markdown</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="![{{filename}}]({{url}})">
                                </div>
                            </div>
                        </div>
                        <div class="dlinput_header mt3">Removal Link (to delete the image)</div>
                        <div class="dlinput_container">
                            <div class="row">
                                <div class="col-md-8">
                                    <input class="form-control" type="text" onclick="this.select();" value="{{delete_url}}">
                                </div>
                            </div>
                        </div>
                    </td>

                                                <td style="width:260px;" class="advert">
                        </td>

                </tr></tbody>
            </table>
        </fieldset>
    </script>
<script>
        let $smfile = $("#file");
        $smfile.fileinput({
            theme: "fas",
            uploadUrl: '//onstudy.cc/uploader.php',
            uploadExtraData: function (previewId, index) {
                var dataArray = $("#upload_option").serializeArray(),
                    len = dataArray.length,
                    dataObj = { };

                for (let i=0; i<len; i++) {
                    dataObj[dataArray[i].name] = dataArray[i].value;
                }
                return dataObj;
            },
            allowedFileExtensions : ['jpeg','jpg','png','gif','bmp','webp'],
            overwriteInitial: false,
            previewFileType: "image",
            maxFileSize: '5242',
            maxFileCount: '100',
            maxAjaxThreads: 2,
            autoOrientImage: true,
            fileActionSettings: {
                showRemove: true,
                showUpload: false,
                showZoom: true,
                showDrag: true,
            },
            browseClass: "btn btn-success",
            browseLabel: "Select Image(s)",
            browseIcon: "<i class=\"fas fa-images\"></i> ",
            removeClass: "btn btn-danger",
            removeLabel: "Clear",
            uploadClass: "btn btn-info",
            uploadLabel: "Upload",
            dropZoneTitle: "Drag & drop files here ...<br>or<br>Copy & paste screenshots here ...",
            //showPreview: false
        });

        function hasHtmlTags(string) {
            var pattern = /<(.*)>/;
            console.log(pattern.test(string));
            return pattern.test(string);
        }

        $smfile.on('fileselect', function(event, numFiles, label) {
            var files = $('#file').fileinput('getFileStack');
            $.each(files, function( index, blob ) {
                if (hasHtmlTags(blob.name)) {
                    let filename = DOMPurify.sanitize(blob.name);
                    filename = filename.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const myNewFile = new File([blob], filename, { type: blob.type });
                    $smfile.fileinput('updateStack', index, myNewFile);
                }
            });
        });
        var clip = function(el) {
            var range = document.createRange();
            range.selectNodeContents(el);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        };

        document.addEventListener('paste', function (event) {
            var isChrome = false;
            if ( event.clipboardData || event.originalEvent ) {
                var clipboardData = (event.clipboardData || event.originalEvent.clipboardData);
                if ( clipboardData.items ) {
                    // for chrome
                    var  items = clipboardData.items,
                        len = items.length,
                        blob = null;
                    isChrome = true;

                    event.preventDefault();

                    let images = [];
                    for (var i = 0; i < len; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            blob = items[i].getAsFile();
                            images.push(blob);
                        }
                    }
                    if(images.length > 0) {
                        uploadBlobFile(images);
                    }
                    if ( blob !== null ) {
                        let reader = new FileReader();
                        reader.onload = function (event) {
                            let base64_str = event.target.result;
                        }

                    }
                } else {
                    //for firefox
                }
            } else {
            }
        });

        function uploadBlobFile(images) {
            let form = $("#file");
            swal({
                title: "提醒",
                text: "是否添加粘贴的图片?",
                icon: "warning",
                dangerMode: true,
                buttons: {
                    cancel: {
                        text: "Cancel",
                        visible: true,
                        closeModal: true,
                    },
                    confirm: {
                        text: "OK",
                        value: true,
                        visible: true,
                        closeModal: true
                    }
                }
            }).then(function (willUpload) {
                if (willUpload) {
                  var dt = new DataTransfer();
                    $.each(images, function( index, blob ) {
                        //$(form).fileinput('readFiles', blob);
                        dt.items.add(blob);
                    });
                    $(form).fileinput('disablePreview');
                    $(form).fileinput('readFiles', dt.files);
                    //$(form).fileinput('upload');
                }
            });
        }

        function DrawImage(ImgD,FitWidth,FitHeight){
            var image=new Image();
            image.src=ImgD.src;
            if(image.width>0 && image.height>0){
                if(image.width <= 260 && image.height <=260) {
                    return;
                }
                if(image.width/image.height>= FitWidth/FitHeight){
                    if(image.width>FitWidth){
                        ImgD.width=FitWidth;
                        ImgD.height=(image.height*FitWidth)/image.width;
                    }else{
                        ImgD.width=image.width;
                        ImgD.height=image.height;
                    }
                } else{
                    if(image.height>FitHeight){
                        ImgD.height=FitHeight;
                        ImgD.width=(image.width*FitHeight)/image.height;
                    }else{
                        ImgD.width=image.width;
                        ImgD.height=image.height;
                    }
                }
            }
        }
        function formatHtml(data) {
            tpl = $('#image-template').html();
            template = Handlebars.compile(tpl);
            return template(data);
        }

        var uploaded_files = [];

        function render_uploaded() {
          $('#imagedetail').html("");
          $('#urlcode').html("");
          $('#linkcode').html("");
          $('#htmlcode').html("");
          $('#bbcode').html("");
          $('#markdown').html("");
          $('#removelink').html("");
          $("#showurl").hide();
          if (uploaded_files.length == 0)
            return;
          uploaded_files.sort(function(a, b){return a.index - b.index;});
          if($('#showurl').html()) {
              $("#showurl").show();
          }
          uploaded_files.forEach(function(x) {
            //var name = x.name;
            var resp = x.resp;
            var name = (new URL(resp.data.url)).pathname.split('/').pop();
            $('#imagedetail').append(formatHtml(resp.data));
            $('#urlcode').append(resp.data.url + "\n");
            $('#htmlcode').append("&lt;img src=\""+ (resp.data.thumb == null ? resp.data.url : resp.data.thumb.url) +"\" /&gt;" + "\n");
            $('#bbcode').append("[img]"+ (resp.data.thumb == null ? resp.data.url : resp.data.thumb.url) +"[/img]" + "\n");
            $('#markdown').append("!["+ name + "](" + (resp.data.thumb == null ? resp.data.url : resp.data.thumb.url) + ")" + "\n");
            $('#removelink').append(resp.data.delete_url + "\n");
          });
        }

        $smfile.on('fileuploaded', function(event, data, previewId, index) {
            var form = data.form, files = data.files, extra = data.extra, response = data.response, reader = data.reader;
            if(response.code === 'success') {
              uploaded_files.push({index: index, resp: response});
              render_uploaded();
            }
        });
        $smfile.on('fileclear', function(event){
            $smfile.fileinput("enablePreview");
        });
        $smfile.on('filecleared', function(event) {
            if($("#showurl").is(":visible")) {
                layer.confirm('是否要清空历史上传', {
                    btn: ['Yes', 'No'] //按钮
                }, function(index){
                    uploaded_files = [];
                    render_uploaded();
                    layer.close(index);
                }, function(){
                });
            }
        });

        $.prototype.fileinput.Constructor.prototype["setUploadUrl"] = function(url) {
            this.uploadUrl = url;
        };

        $.prototype.fileinput.Constructor.prototype["getUploadUrl"] = function() {
            return this.uploadUrl;
        };

        $.prototype.fileinput.Constructor.prototype["disablePreview"] = function() {
            this.showPreview = false;
        };

        $.prototype.fileinput.Constructor.prototype["enablePreview"] = function() {
            this.showPreview = true;
        };

        $.prototype.fileinput.Constructor.prototype["setFinalUrl"] = function(func) {
            this.finalUrl = func;
        };

        $.prototype.fileinput.Constructor.prototype["setBeforeAjaxEnqueue"] = function(func) {
            this.beforeAjaxEnqueue = func;
        };

        var upload_baseurl = `${$smfile.fileinput("getUploadUrl")}?ts=${Date.now()}&rand=${Math.random()}`;

        $smfile.on('filelock', function(event, filestack, extraData) {
          $smfile.fileinput("setUploadUrl", `${upload_baseurl}&batch_size=${Object.keys(filestack).length}`);
        });

        var backend_idx = parseInt(Math.random() * 1000000007) % 10;
        $smfile.fileinput("setFinalUrl", function(url, fileId) {
          backend_idx = (backend_idx + 1) % 10;
          return url.replace("XXXXXX", `${backend_idx}`);
        });

        $smfile.fileinput("setBeforeAjaxEnqueue", function(settings) {
          delete settings['fileId'];
          var file = settings.data.get("file");
          // var pdata = file.arrayBuffer();
          var blob = file.slice();
          var uri = decodeURI(settings.url);
          var filename = file.name;
          uri = uri + "&filename=" + filename;
          /* return pdata.then((data)=>{
            settings.url = encodeURI(uri);
            settings.data = data;
            return Promise.resolve(settings);
          }, ()=>{
            return Promise.resolve(settings);
          });*/
          settings.url = encodeURI(uri);
          settings.data = blob;
          return settings;
        });

        let div_caption = $(".kv-fileinput-caption");
        div_caption.attr('onclick','clickFile()');
        function clickFile() {
            $smfile.click();
        }

        $smfile.on('filebatchuploadcomplete', function(event, files, extra) {
            $('img.lazy').lazyload();
        });
    </script>

</body>
</html>
